<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Minimal ECS task with fargate backend | Devbay</title><meta name=keywords content="aws,terraform"><meta name=description content="This article was published at https://karnwong.me
To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><meta name=author content="map[author:[Karn Wong Apiporn Simapornchai]]"><link rel=canonical href=https://devbaygroup.github.io/posts/2022-08-26-minimal-ecs-task-with-fargate-backend/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d863fd5f0e25d2825e7da82453f7db938303670b0465bdd3058f97195389f636.css integrity="sha256-2GP9Xw4l0oJefagkU/fbk4MDZwsEZb3TBY+XGVOJ9jY=" rel="preload stylesheet" as=style><link rel=icon href=https://devbaygroup.github.io/favicon.ico><link rel=apple-touch-icon href=https://devbaygroup.github.io/apple-touch-icon.png><meta name=twitter:title content="Minimal ECS task with fargate backend | Devbay"><meta name=twitter:description content="This article was published at https://karnwong.me
To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><meta property="og:title" content="Minimal ECS task with fargate backend | Devbay"><meta property="og:description" content="This article was published at https://karnwong.me
To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><meta property="og:type" content="article"><meta property="og:url" content="https://devbaygroup.github.io/posts/2022-08-26-minimal-ecs-task-with-fargate-backend/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-26T21:10:58+07:00"><meta property="article:modified_time" content="2022-08-26T21:10:58+07:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://devbaygroup.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Minimal ECS task with fargate backend","item":"https://devbaygroup.github.io/posts/2022-08-26-minimal-ecs-task-with-fargate-backend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Minimal ECS task with fargate backend | Devbay","name":"Minimal ECS task with fargate backend","description":"This article was published at https://karnwong.me\nTo deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to \u0026ldquo;update\u0026rdquo; the app manually if I add changes to it.\nThings would be super cool if: after I push the changes to master branch, the app would be deployed automatically.","keywords":["aws","terraform"],"wordCount":"585","inLanguage":"en","datePublished":"2022-08-26T21:10:58+07:00","dateModified":"2022-08-26T21:10:58+07:00","author":{"@type":"Person","name":{"author":["Karn Wong","Apiporn Simapornchai"]}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devbaygroup.github.io/posts/2022-08-26-minimal-ecs-task-with-fargate-backend/"},"publisher":{"@type":"Organization","name":"Devbay","logo":{"@type":"ImageObject","url":"https://devbaygroup.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://devbaygroup.github.io/ accesskey=h title="Devbay (Alt + H)">Devbay</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://devbaygroup.github.io/posts/ title=Posts class=active>Posts</a></li><li><a href=https://devbaygroup.github.io/tags/ title=Tags>Tags</a></li><li><a href=https://devbaygroup.github.io/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devbaygroup.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://devbaygroup.github.io/posts/>Posts</a></div><h1 class=post-title>Minimal ECS task with fargate backend</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>August 26, 2022</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://devbaygroup.github.io/tags/aws/>aws</a><a href=https://devbaygroup.github.io/tags/terraform/>terraform</a></span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>3 min</span></span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#task-definition aria-label="Task definition">Task definition</a></li><li><a href=#ssl-certificate aria-label="SSL certificate">SSL certificate</a></li><li><a href=#load-balancer aria-label="Load balancer">Load balancer</a></li><li><a href=#autoscaling aria-label=Autoscaling>Autoscaling</a></li></ul></div></details></div><div class=post-content><p><em>This article was published at <a href=https://karnwong.me>https://karnwong.me</a></em></p><p>To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.</p><p>Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically. In order to achieve this, I could use AWS ECS task to deploy the app, and add CI/CD to it (because this is 2022 after all).</p><p>And things would be even better if I don&rsquo;t have to set up the infra manually every time I want to deploy an app, enters terraform!</p><p>Below are minimal ecs task with fargate backend setup ð. Repo <a href=https://github.com/devbaygroup/terraform-aws-ecs-fargate-example>here</a>.</p><p><em>Updated 2022-09-02</em></p><p>Notes: you might need to set up autoscaling on LB connections per target. Also this example contains two target tracking policies for the same service. Race conditions can result in undesirable scaling issues. Thanks John Mille!</p><h2 id=task-definition>Task definition<a hidden class=anchor aria-hidden=true href=#task-definition>Â¶</a></h2><p>This is equivalent to docker-compose.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_cloudwatch_log_group&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  retention_in_days</span> <span class=o>=</span> <span class=m>14</span>
</span></span><span class=line><span class=cl><span class=n>  name</span>              <span class=o>=</span> <span class=s2>&#34;/aws/ecs/${var.service_name}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_ecs_task_definition&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  family</span>                   <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  network_mode</span>             <span class=o>=</span> <span class=s2>&#34;awsvpc&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  requires_compatibilities</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;FARGATE&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  cpu</span>                      <span class=o>=</span> <span class=m>256</span>
</span></span><span class=line><span class=cl><span class=n>  memory</span>                   <span class=o>=</span> <span class=m>512</span>
</span></span><span class=line><span class=cl><span class=n>  execution_role_arn</span>       <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>task_role</span>
</span></span><span class=line><span class=cl><span class=n>  task_role_arn</span>            <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>task_role</span>
</span></span><span class=line><span class=cl><span class=n>  container_definitions</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl><span class=n>        name</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>        image</span>       <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>image_uri</span>
</span></span><span class=line><span class=cl><span class=n>        essential</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>        environment</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>        portMappings</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          {
</span></span><span class=line><span class=cl><span class=n>            protocol</span>      <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>            containerPort</span> <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>            hostPort</span>      <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>        logConfiguration</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>          logDriver</span> <span class=o>=</span> <span class=s2>&#34;awslogs&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          options</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>            awslogs-group</span>         <span class=o>=</span> <span class=k>aws_cloudwatch_log_group</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>            awslogs-region</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>aws_region</span>
</span></span><span class=line><span class=cl><span class=n>            awslogs-stream-prefix</span> <span class=o>=</span> <span class=s2>&#34;ecs&#34;</span>
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_ecs_service&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>                               <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  cluster</span>                            <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>ecs_cluster_id</span>
</span></span><span class=line><span class=cl><span class=n>  task_definition</span>                    <span class=o>=</span> <span class=k>aws_ecs_task_definition</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  desired_count</span>                      <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>  deployment_minimum_healthy_percent</span> <span class=o>=</span> <span class=m>50</span>
</span></span><span class=line><span class=cl><span class=n>  deployment_maximum_percent</span>         <span class=o>=</span> <span class=m>200</span>
</span></span><span class=line><span class=cl><span class=n>  launch_type</span>                        <span class=o>=</span> <span class=s2>&#34;FARGATE&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  scheduling_strategy</span>                <span class=o>=</span> <span class=s2>&#34;REPLICA&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>network_configuration</span> {
</span></span><span class=line><span class=cl><span class=n>    security_groups</span>  <span class=o>=</span> <span class=p>[</span><span class=k>var</span><span class=p>.</span><span class=k>alb_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>    subnets</span>          <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>subnet_id</span>
</span></span><span class=line><span class=cl><span class=n>    assign_public_ip</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>load_balancer</span> {
</span></span><span class=line><span class=cl><span class=n>    target_group_arn</span> <span class=o>=</span> <span class=k>aws_alb_target_group</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>    container_name</span>   <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>    container_port</span>   <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=ssl-certificate>SSL certificate<a hidden class=anchor aria-hidden=true href=#ssl-certificate>Â¶</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_acm_certificate&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  domain_name</span>       <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>domain_name</span>
</span></span><span class=line><span class=cl><span class=n>  validation_method</span> <span class=o>=</span> <span class=s2>&#34;DNS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>lifecycle</span> {
</span></span><span class=line><span class=cl><span class=n>    create_before_destroy</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    Name</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>domain_name</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=load-balancer>Load balancer<a hidden class=anchor aria-hidden=true href=#load-balancer>Â¶</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_lb&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>               <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  internal</span>           <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl><span class=n>  load_balancer_type</span> <span class=o>=</span> <span class=s2>&#34;application&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_groups</span>    <span class=o>=</span> <span class=p>[</span><span class=k>var</span><span class=p>.</span><span class=k>alb_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  subnets</span>            <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>subnet_id</span>
</span></span><span class=line><span class=cl><span class=n>  idle_timeout</span>       <span class=o>=</span> <span class=m>3600</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  enable_deletion_protection</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_alb_target_group&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  port</span>        <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>    <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl><span class=n>  target_type</span> <span class=o>=</span> <span class=s2>&#34;ip&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>health_check</span> {
</span></span><span class=line><span class=cl><span class=n>    healthy_threshold</span>   <span class=o>=</span> <span class=s2>&#34;3&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    interval</span>            <span class=o>=</span> <span class=s2>&#34;30&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>            <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    matcher</span>             <span class=o>=</span> <span class=s2>&#34;200&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    timeout</span>             <span class=o>=</span> <span class=s2>&#34;3&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    path</span>                <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>health_check_path</span>
</span></span><span class=line><span class=cl><span class=n>    unhealthy_threshold</span> <span class=o>=</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_alb_listener&#34; &#34;http&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  load_balancer_arn</span> <span class=o>=</span> <span class=k>aws_lb</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  port</span>              <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>          <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>default_action</span> {
</span></span><span class=line><span class=cl><span class=n>    type</span>             <span class=o>=</span> <span class=s2>&#34;forward&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    target_group_arn</span> <span class=o>=</span> <span class=k>aws_alb_target_group</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_alb_listener&#34; &#34;https&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  load_balancer_arn</span> <span class=o>=</span> <span class=k>aws_lb</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  port</span>              <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>          <span class=o>=</span> <span class=s2>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  ssl_policy</span>      <span class=o>=</span> <span class=s2>&#34;ELBSecurityPolicy-2016-08&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  certificate_arn</span> <span class=o>=</span> <span class=k>aws_acm_certificate</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>default_action</span> {
</span></span><span class=line><span class=cl><span class=n>    target_group_arn</span> <span class=o>=</span> <span class=k>aws_alb_target_group</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>    type</span>             <span class=o>=</span> <span class=s2>&#34;forward&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=autoscaling>Autoscaling<a hidden class=anchor aria-hidden=true href=#autoscaling>Â¶</a></h2><p>Because we are using cloud, and I love taking advantage of dynamic resources allocation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_appautoscaling_target&#34; &#34;this&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  max_capacity</span>       <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>  min_capacity</span>       <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span>        <span class=o>=</span> <span class=s2>&#34;service/${var.ecs_cluster_name}/${aws_ecs_service.this.name}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  scalable_dimension</span> <span class=o>=</span> <span class=s2>&#34;ecs:service:DesiredCount&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_namespace</span>  <span class=o>=</span> <span class=s2>&#34;ecs&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_appautoscaling_policy&#34; &#34;memory&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>               <span class=o>=</span> <span class=s2>&#34;memory-autoscaling&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  policy_type</span>        <span class=o>=</span> <span class=s2>&#34;TargetTrackingScaling&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span>        <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>resource_id</span>
</span></span><span class=line><span class=cl><span class=n>  scalable_dimension</span> <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>scalable_dimension</span>
</span></span><span class=line><span class=cl><span class=n>  service_namespace</span>  <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>service_namespace</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>target_tracking_scaling_policy_configuration</span> {
</span></span><span class=line><span class=cl>    <span class=k>predefined_metric_specification</span> {
</span></span><span class=line><span class=cl><span class=n>      predefined_metric_type</span> <span class=o>=</span> <span class=s2>&#34;ECSServiceAverageMemoryUtilization&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>    target_value</span> <span class=o>=</span> <span class=m>40</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_appautoscaling_policy&#34; &#34;cpu&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>               <span class=o>=</span> <span class=s2>&#34;cpu-autoscaling&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  policy_type</span>        <span class=o>=</span> <span class=s2>&#34;TargetTrackingScaling&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span>        <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>resource_id</span>
</span></span><span class=line><span class=cl><span class=n>  scalable_dimension</span> <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>scalable_dimension</span>
</span></span><span class=line><span class=cl><span class=n>  service_namespace</span>  <span class=o>=</span> <span class=k>aws_appautoscaling_target</span><span class=p>.</span><span class=k>this</span><span class=p>.</span><span class=k>service_namespace</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>target_tracking_scaling_policy_configuration</span> {
</span></span><span class=line><span class=cl>    <span class=k>predefined_metric_specification</span> {
</span></span><span class=line><span class=cl><span class=n>      predefined_metric_type</span> <span class=o>=</span> <span class=s2>&#34;ECSServiceAverageCPUUtilization&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    target_value</span> <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devbaygroup.github.io/>Devbay</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>